<!DOCTYPE html>
<!--
Copyright (c) 2013 The Chromium Authors. All rights reserved.
Use of this source code is governed by a BSD-style license that can be
found in the LICENSE file.
-->
<link rel="import" href="/base/base.html">
<link rel="import" href="/core/auditor.html">
<link rel="import" href="/extras/audits/android_model_helper.html">
<link rel="import" href="/extras/audits/utils.html">

<script>
'use strict';

/**
 * @fileoverview Class for Android-specific Auditing
 */
tv.exportTo('tv.e.audits', function() {
  // TODO: extract from VSYNC, since not all devices have vsync near 60fps
  var EXPECTED_FRAME_TIME = 16.67;

  var Auditor = tv.c.Auditor;
  var AndroidModelHelper = tv.e.audits.AndroidModelHelper;

  /**
   * Auditor for Android-specific traces.
   * @constructor
   */
  function AndroidAuditor(model) {
    this.model = model;
    this.helper = new AndroidModelHelper(model);
  };

  AndroidAuditor.prototype = {
    __proto__: Auditor.prototype,

    runAnnotate: function() {
      var badFramesObserved = 0;
      var framesObserved = 0;
      this.helper.apps.forEach(function(app) {
        // override frame list
        app.process.frames = app.getFrames();

        app.process.frames.forEach(function(frame) {
          if (frame.totalDuration > EXPECTED_FRAME_TIME)
            badFramesObserved++;
        });
        framesObserved += app.process.frames.length;
      });

      var portionBad = badFramesObserved / framesObserved;
      if (portionBad > 0.3)
        this.model.faviconHue = 'red';
      else if (portionBad = 0.05)
        this.model.faviconHue = 'green';
    },

    runAudit: function() {
      this.helper.apps.forEach(function(app) {
        // per frame alerts
        app.getFrames().forEach(this.getFrameTimingAlerts, this);

        // general alerts
        this.addSaveLayerAlerts(app.renderThread);
      }, this);
    },

    getFrameTimingAlerts: function(frame) {
      /*
      * Currently, we create alerts for these, but really we should
      * highlight frame-production-performance isolated per app,
      * without alerts.
      *
      * Consider highlighting process background green when frames
      * take < 16.6ms, yellow when double buffered but not dropping
      * frames, red when actively janking.
      */
      if (frame.totalDuration > EXPECTED_FRAME_TIME) {
        var alertType = new tv.c.trace_model.AlertType(
            'Long frame',
            'Frames should take fewer than' + EXPECTED_FRAME_TIME +
            'ms to ensure smooth performance.',
            tv.c.trace_model.ALERT_SEVERITY.WARNING);
        var alert = new tv.c.trace_model.Alert(
            alertType,
            frame.start, { 'totalDuration' : frame.totalDuration });
        this.model.alerts.push(alert);
      }
    },

    addSaveLayerAlerts: function(renderThread) {
      if (!renderThread)
        return;
      var saveLayerRegEx = /caused (unclipped )?saveLayer (\d+)x(\d+)/;
      renderThread.sliceGroup.slices.forEach(function(slice) {
        var match = saveLayerRegEx.exec(slice.title);
        if (match) {
          var alertType = new tv.c.trace_model.AlertType(
              'Inefficient Alpha',
              'http://developer.android.com/reference/android/view/View.html#setAlpha(float)', // @suppress longLineCheck
              tv.c.trace_model.ALERT_SEVERITY.CRITICAL);
          var args = { 'width' : parseInt(match[2]),
                       'height' : parseInt(match[3]) };
          var alert = new tv.c.trace_model.Alert(alertType, slice.start, args);
          this.model.alerts.push(alert);
        }
        // TODO: also do something reasonable with standalone saveLayer commands
      }, this);
    }
  };

  Auditor.register(AndroidAuditor);

  return {
    AndroidAuditor: AndroidAuditor
  };
});
</script>
